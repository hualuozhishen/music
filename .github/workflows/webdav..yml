name: ä¸Šä¼ éŸ³ä¹åˆ°äº‘ç›˜

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0'

permissions:
  contents: read

jobs:
  upload-music:
    runs-on: ubuntu-latest
    env:
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASS: ${{ secrets.WEBDAV_PASS }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip curl
          curl https://rclone.org/install.sh | sudo bash

      - name: é…ç½®WebDAV
        run: |
          rclone config create webdav webdav url="${WEBDAV_URL}" vendor=other user="${WEBDAV_USER}" pass="${WEBDAV_PASS}" --non-interactive

      - name: é€ä¸€æ£€æµ‹å¹¶ä¸Šä¼ æ–‡ä»¶
        run: |
          set -e
          UPLOAD_PATH="webdav:/music"
          rclone mkdir "$UPLOAD_PATH" || true

          find public/music -type f \( -name "*.mp3" -o -name "*.flac" -o -name "*.wav" -o -name "*.m4a" -o -name "*.ogg" -o -name "*.aac" \) | while read file; do
            filename=$(basename "$file")
            
            echo "ğŸµ æ£€æµ‹æ–‡ä»¶: $filename"

            local_md5=$(md5sum "$file" | awk '{print $1}')

            if rclone ls "$UPLOAD_PATH/$filename" >/dev/null 2>&1; then
              echo "â˜ï¸ äº‘ç«¯æœ‰åŒåæ–‡ä»¶ â†’ è¿›è¡ŒMD5å¯¹æ¯”"

              tmp_file="/tmp/remote_file"
              rm -f "$tmp_file"

              # æ­£ç¡®ä¸‹è½½ä¸ºæ–‡ä»¶
              rclone cat "$UPLOAD_PATH/$filename" > "$tmp_file"
              
              remote_md5=$(md5sum "$tmp_file" | awk '{print $1}')
              rm -f "$tmp_file"

              echo "æœ¬åœ°MD5:  $local_md5"
              echo "äº‘ç«¯MD5:  $remote_md5"
              
              if [ "$local_md5" == "$remote_md5" ]; then
                echo "âœ… å†…å®¹å®Œå…¨ä¸€è‡´ â†’ è·³è¿‡ä¸Šä¼ "
                continue
              else
                echo "âš ï¸ å†…å®¹ä¸åŒ â†’ æ‰§è¡Œé‡æ–°ä¸Šä¼ "
              fi
            else
              echo "ğŸ†• äº‘ç«¯ä¸å­˜åœ¨è¯¥æ–‡ä»¶ â†’ æ‰§è¡Œä¸Šä¼ "
            fi

            rclone copy "$file" "$UPLOAD_PATH" --progress
          done

          echo "ğŸ‰ å®Œæˆå…¨éƒ¨ä»»åŠ¡"
